# Jenkins Configuration as Code - Main Configuration
# This is the main JCasC file that includes all modular configurations
# Managed by Ansible - Do not edit manually

jenkins:
  # System message
  systemMessage: "Jenkins configured automatically by Ansible | Docker Cloud enabled"

  # Global properties
  globalNodeProperties:
    - envVars:
        env:
          - key: "DOCKER_HOST"
            value: "{{ jenkins_docker_cloud_docker_host }}"
          - key: "DOCKER_TLS_VERIFY"
            value: ""
          - key: "DOCKER_CERT_PATH"
            value: ""

# Tool configuration
tool:
  git:
    installations:
      - name: "Default Git"
        home: "/usr/bin/git"

# Include modular configurations
---
# Users and Security Configuration
jenkins:
  securityRealm:
    local:
      allowsSignup: false
      users:
        - id: "{{ jenkins_admin_user }}"
          password: "{{ jenkins_admin_password }}"
          name: "Administrator"
          email: "{{ jenkins_admin_email | default('admin@localhost') }}"

        {% if additional_users is defined %}
        {% for user in additional_users %}
        - id: "{{ user.id }}"
          password: "{{ user.password }}"
          name: "{{ user.name | default('') }}"
          email: "{{ user.email | default('') }}"
        {% endfor %}
        {% endif %}

  authorizationStrategy:
    fullControlOnceLoggedIn:
      allowAnonymousRead: false

  disableRememberMe: false

---
# Docker Cloud Configuration
clouds:
  - docker:
      name: "docker-cloud"
      dockerApi:
        dockerHost:
          uri: "{{ jenkins_docker_cloud_docker_host }}"
      containerCap: 10
      connectTimeout: 5
      readTimeout: 60
      templates:
        - description: "Docker Cloud build agent"
          label: "docker-agent"
          dockerImage: "{{ jenkins_docker_cloud_container_template.image | default('docker:dind') }}"
          remoteFs: "/home/jenkins"
          connector:
            attach:
              user: "root"
          removeVolumes: true
          stopTimeout: 10
          pullStrategy: PULL_ALWAYS
          privileged: true
          environment:
            - "DOCKER_HOST={{ jenkins_docker_cloud_docker_host }}"
            - "DOCKER_TLS_VERIFY="
            - "DOCKER_CERT_PATH="
          volumes:
            - "/var/run/docker.sock:/var/run/docker.sock"
            - "/home/jenkins:/home/jenkins"
          memoryLimit: {{ jenkins_docker_cloud_container_template.memory_limit | default(2147483648) }}
          cpuLimit: {{ jenkins_docker_cloud_container_template.cpu_limit | default(2) }}
          retentionStrategy:
            idleMinutes: 10
          numExecutors: 1
          nodeUsageMode: NORMAL

---
# Credentials Configuration
credentials:
  system:
    domainCredentials:
      - credentials:
          - usernamePassword:
              scope: SYSTEM
              id: "docker-registry-credentials"
              username: "{{ docker_registry_username | default('docker-user') }}"
              password: "{{ docker_registry_password | default('docker-password') }}"
              description: "Docker Registry Credentials"

          {% if additional_credentials is defined %}
          {% for cred in additional_credentials %}
          - usernamePassword:
              scope: {{ cred.scope | default('SYSTEM') }}
              id: "{{ cred.id }}"
              username: "{{ cred.username }}"
              password: "{{ cred.password }}"
              description: "{{ cred.description | default('') }}"
          {% endfor %}
          {% endif %}
