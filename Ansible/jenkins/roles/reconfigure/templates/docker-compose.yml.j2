---
# Docker Compose configuration for Jenkins with Docker Cloud
# Managed by Ansible - Do not edit manually

services:
  # Docker Cloud service for running Docker daemons
  docker-cloud:
    image: {{ jenkins_docker_cloud_image | default('docker:dind') }}
    container_name: {{ jenkins_docker_cloud_container_name | default('docker-cloud') }}
    privileged: true
    restart: always
    networks:
      - {{ jenkins_docker_cloud_network_name | default('jenkins-network') }}
    volumes:
      - docker_cloud_data:/var/lib/docker
    environment:
      - DOCKER_HOST=tcp://0.0.0.0:2375
      - DOCKER_TLS_VERIFY=
      - DOCKER_CERT_PATH=
    expose:
      - "2375"
    command: ["--host", "tcp://0.0.0.0:2375"]

  # Jenkins CI/CD service
  jenkins:
    image: {{ jenkins_docker_image | default('jenkins/jenkins:lts') }}
    container_name: {{ jenkins_container_name | default('jenkins') }}
    restart: always
    networks:
      - {{ jenkins_docker_cloud_network_name | default('jenkins-network') }}
    ports:
      - "{{ jenkins_hostname | default('0.0.0.0') }}:{{ jenkins_host_port | default(8080) }}:8080"
      - "{{ jenkins_agent_port | default(50000) }}:50000"
    volumes:
      - jenkins_data:/var/jenkins_home
      - {{ role_path }}/files/jcasc:/var/jenkins_home/casc_configs:ro
    environment:
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=false -Dcasc.jenkins.config=/var/jenkins_home/casc_configs
      - CASC_JENKINS_CONFIG=/var/jenkins_home/casc_configs
      - DOCKER_HOST={{ jenkins_docker_cloud_docker_host | default('tcp://docker-cloud:2375') }}
      - DOCKER_TLS_VERIFY=
      - DOCKER_CERT_PATH=
    labels:
      app: jenkins
    depends_on:
      - docker-cloud

networks:
  {{ jenkins_docker_cloud_network_name | default('jenkins-network') }}:
    driver: bridge

volumes:
  jenkins_data:
    driver: local
  docker_cloud_data:
    driver: local
