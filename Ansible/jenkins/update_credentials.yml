---
# Playbook to update Jenkins credentials only
# Use this playbook when you only need to manage credentials
#
# Usage:
#   # Add/update credentials
#   ansible-playbook update_credentials.yml -e "target_hosts=all"
#
#   # With custom credentials file
#   ansible-playbook update_credentials.yml -e "target_hosts=all" \
#     -e "additional_credentials=[{'id': 'my-cred', 'username': 'user', 'password': 'pass'}]"

- name: Update Jenkins Credentials
  hosts: "{{ target_hosts | default('all') }}"
  become: true

  vars:
    jenkins_admin_user: "admin"
    jenkins_admin_password: "admin"
    jenkins_host_port: 8080

  pre_tasks:
    - name: Check if Jenkins is running
      command: docker ps --filter name={{ jenkins_container_name | default('jenkins') }} --format "{{ '{{' }}.Names{{ '}}' }}"
      register: jenkins_running
      changed_when: false
      failed_when: jenkins_running.stdout == ""
      tags:
        - credentials
        - always

    - name: Wait for Jenkins to be ready
      wait_for:
        host: localhost
        port: "{{ jenkins_host_port }}"
        timeout: 60
        delay: 5
      tags:
        - credentials
        - always

  tasks:
    - name: Load additional credentials configuration
      include_vars:
        file: "{{ role_path | default('.') }}/files/credentials.yml"
      when: additional_credentials is not defined
      tags:
        - credentials
        - always

    - name: Create JCasC configuration directory
      file:
        path: "{{ role_path | default('.') }}/files/jcasc"
        state: directory
      tags:
        - credentials
        - jcasc
        - always

    - name: Generate JCasC credentials configuration
      template:
        src: templates/jcasc-credentials.yaml.j2
        dest: "{{ role_path | default('.') }}/files/jcasc/jcasc-credentials.yaml"
        mode: '0644'
      tags:
        - credentials
        - jcasc
        - always

    - name: Reload JCasC configuration
      uri:
        url: "http://localhost:{{ jenkins_host_port }}/reload-configuration-as-code"
        method: POST
        status_code: [200, 302, 403]
      tags:
        - credentials
        - jcasc
        - reload
